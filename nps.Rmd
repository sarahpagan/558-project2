---
title: "NPS API Vignette"
subtitle: "Vignette for pulling data from the National Park Service API"
author: "Sarah Pagan"
output: 
  github_document:
    toc: TRUE
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(httr)
library(jsonlite)
library(dplyr)
library(tidyr)
library(ggplot2)
library(sf)

my_key <- "oKmYKW6S1dOrI47ra4laE70chvKFy5WGV1c0Pjgo"
```

This document demonstrates how to retrieve data from the National Parks Service (NPS) [API](https://www.nps.gov/subjects/developer/api-documentation.htm). The NPS API provides access to data about NPS sites and their activities, campgrounds, events, photos, and more. In this vignette, I build functions interacting with four of the API's endpoints. I then use these functions to perform some exploratory data analysis.

![ ](parks.png)

# Requirements

# API Interaction Functions

## get_NPS_parks

This function interacts with the parks endpoint to retrieve parks located in your state. The required input is `key` and the optional input is `states`, a character vector of two-letter state codes (e.g. `c("NC", "MI")`).

The output is a tibble of NPS sites. If no state(s) is supplied, the function will return sites in all states. There are numerous site designations within NPS (other than "National Park") and descriptions for each designation can be found [here](https://www.nps.gov/goga/planyourvisit/designations.htm).

```{r}
get_NPS_parks <- function(key, states = NULL){
  if(is.null(states)){
    url <- paste0("https://developer.nps.gov/api/v1/parks?api_key=",
                  key,
                  "&limit=10000")
  }
  
  if(!is.null(states)){
    url <- paste0("https://developer.nps.gov/api/v1/parks?api_key=",
                  key,
                  "&stateCode=",
                  paste(states, collapse = ","),
                  "&limit=10000")
  }

query <- GET(url)
results <- fromJSON(rawToChar(query$content))$data |>
  select(fullName, parkCode, states, designation, latitude, longitude) |>
  mutate(latitude = as.numeric(latitude), longitude = as.numeric(longitude)) |>
  as_tibble()

return(results)
}
```


## get_NPS_activities

This function interacts with the activities/parks endpoint to retrieve parks associated with your activities. The required inputs are `key` and `activities`, a character vector of activities (e.g. `c("Hiking", "Horse Trekking")). The output is a tibble of NPS sites related to the input activities.

```{r}
get_NPS_activities <- function(key, activities){
  acts <- paste(activities, collapse = ",")
  acts <- sub(" ", "%20", acts)
  
  url <- paste0("https://developer.nps.gov/api/v1/activities/parks?api_key=",
                key,
                "&q=",
                acts,
                "&limit=10000")
  
  query <- GET(url)
  results <- fromJSON(rawToChar(query$content))$data$parks
  
  activity <- c()
  for (i in 1:length(activities)){
    y <- rep(activities[i],
             nrow(results[[i]]))
    activity <- append(activity, y)
  }
  
  results <- results |>
    bind_rows() |>
    cbind(activity) |>
    select(fullName, parkCode, states, activity) |>
    as_tibble()
  
  return(results)
}
```

These are the categories of activities defined by NPS:

```{r}
get_activities <- GET(paste0("https://developer.nps.gov/api/v1/activities?api_key=",
                             my_key))
NPS_activities <- fromJSON(rawToChar(get_activities$content))$data$name
NPS_activities
```


## get_NPS_campgrounds

This function interacts with the campgrounds endpoint to retrieve data about amenities at campgrounds in your park.

The preceding function, `get_NPS_codes`, retrieves park codes for all sites. It can be used to look up the official code for your park and is used in the main campgrounds function to join park names by `parkCode`. 

Below, I look up the `parkCode` for each of my parks of interest -- Joshua Tree and the New River Gorge.

```{r}
get_NPS_codes <- function(key) {
  url <- paste0("https://developer.nps.gov/api/v1/parks?api_key=",
                key,
                "&limit=10000")
  query <- GET(url)
  results <- fromJSON(rawToChar(query$content))$data
  results |>
    select(fullName, parkCode, states) |>
    as_tibble()
}
```

```{r}
all_codes <- get_NPS_codes(my_key) 
my_codes <- all_codes |>
  filter(grepl("Joshua Tree|New River", all_codes$fullName))
my_codes
```

Now for the `get_NPS_campgrounds` function, the required input is `key` and the optional input is `park_codes`, a character vector of park codes (e.g. `c("jotr", "neri")`).

```{r}
get_NPS_campgrounds <- function(key, park_codes = NULL){
  parks <- get_NPS_codes(key)
  
  if(is.null(park_codes)){
    url <- paste0("https://developer.nps.gov/api/v1/campgrounds?api_key=",
                  key,
                  "&limit=10000")
  }
  
  if(!is.null(park_codes)){
    url <- paste0("https://developer.nps.gov/api/v1/campgrounds?api_key=",
                  key,
                  "&parkCode=",
                  paste(park_codes, collapse = ","),
                  "&limit=10000")
  }
  
  query <- GET(url)
  camps <- fromJSON(rawToChar(query$content))$data |>
    select(name, parkCode) |>
    left_join(parks)
  results <- cbind(camps, fromJSON(rawToChar(GET(url)$content))$data$amenities)|>
    as_tibble()
  
  return(results)
}
```

# get_NPS_fees

```{r}
get_NPS_fees <- function(key, park_codes){
  url <- paste0("https://developer.nps.gov/api/v1/feespasses?api_key=",
                key,
                "&parkCode=",
                paste(park_codes, collapse = ","),
                "&limit=10000")
  query <- GET(url)
  fromJSON(rawToChar(query$content))$data$fees
}

```

# Exploratory Data Analysis

![ ](bear.jpg)

## NPS Sites in NC

First, let's pull data on all NPS sites in North Carolina using the `get_NPS_parks` function.

```{r}
NC_parks <- get_NPS_parks(my_key, "NC")
NC_parks
```
### What types (designations) of NPS sites are present in North Carolina?

```{r}
NC_parks |>
  group_by(designation) |>
  summarise(count = n()) |>
  arrange(desc(count))
```


```{r}
NC <- NC_parks |>
  filter(parkCode != "trte", parkCode != "appa")

NC_map <- st_read(system.file("shape/nc.shp", package="sf"))
ggplot(NC_map) +
  geom_sf(color = "seagreen3", fill = "honeydew", linewidth = 0.3) +
  geom_point(data = NC, mapping = aes(x = longitude,
                                      y = latitude),
             color = "grey20",
             shape = 17,
             size = 3) +
  ggrepel::geom_text_repel(data = NC, aes(x = longitude,
                                          y = latitude,
                                          label = parkCode),
                           size = 5) +
  theme_void() +
  labs(title = "NPS Sites in North Carolina") +
  theme(plot.title = element_text(hjust = 0.5, size = 20))
```

```{r}
all_parks <- get_NPS_parks(my_key)
all_des <- all_parks |>
  group_by(designation) |>
  filter(!designation == "") |>
  summarise(count = n()) |>
  arrange(desc(count))
all_des
```
```{r}
all_des_5 <- all_des |>
  slice(1:5)

ggplot(data = all_des_5, aes(x = reorder(designation, -count))) +
         geom_col(aes(y = count), color = "seagreen1", linewidth = 2, fill = "seagreen4") +
  xlab(NULL) +
  ylab("count") +
  labs(title = "NPS Sites by Designation: Top 5")
```


## NPS Sites with Climbing and Swimming

Next, let's use the `get_NPS_activities` function to pull data on all parks with "Climbing" and/or "Swimming" recorded as possible activities.

```{r}
climb_swim <- get_NPS_activities(my_key, c("Climbing", "Swimming"))
climb_swim
```

```{r}
climb_swim |>
  group_by(activity) |>
  summarise(count = n())
```

```{r}
climb_swim_states <- climb_swim |>
  separate_rows(states, sep = ",")

ggplot(data = climb_swim_states, aes(x = states)) + 
  geom_bar(aes(fill = activity)) +
  scale_fill_manual(values = c("grey10", "turquoise3")) +
  theme(axis.text.x = element_text(angle = 90)) +
  xlab("state") +
  labs(title = "NPS Sites with Climbing and/or Swimming by State")
```

```{r}
climb_and_swim <- climb_swim |>
  group_by(fullName) |>
  filter(n() > 1) |>
  select(-activity) |>
  distinct(fullName, states)

climb_and_swim
```
 
##  Campground Amenities at grsm

```{r}
my_camps <- get_NPS_campgrounds(my_key, "grsm")
my_camps
```

```{r}
my_camps_heat <- my_camps |>
  slice(1:12) |>
  select(name,
         cellPhoneReception,
         potableWater,
         toilets,
         trashRecyclingCollection,
         campStore,
         foodStorageLockers,
         firewoodForSale) |>
  mutate(potableWater = unlist(potableWater)) |>
  mutate(toilets = unlist(toilets)) |>
  pivot_longer(!name, names_to = "var", values_to = "value") |>
  mutate(value = recode(value, 
                        "No" = "0",
                        "No water" = "0",
                        "Yes - year round" = "1",
                        "Yes - seasonal" = "0.5",
                        "Flush Toilets - year round" = "1",
                        "Flush Toilets - seasonal" = "0.5")) |>
  mutate(value = as.numeric(value))

ggplot(my_camps_heat, aes(x = name, y = var, fill = value)) +
  geom_tile() +
  scale_fill_gradient(low = "grey1", high = "turquoise1", name = "") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  xlab(NULL) + ylab(NULL) +
  labs(title = "Campground Amenities:
Great Smoky Mountains National Park")
  
```

```{r}
all_codes <- as.vector(get_NPS_codes(my_key)$parkCode)
fees <- bind_rows(get_NPS_fees(my_key, all_codes)) |>
  as_tibble() |>
  select(entranceFeeType, cost) |>
  mutate(cost = as.numeric(cost)) |>
  filter(entranceFeeType == "Entrance - Private Vehicle"|
         entranceFeeType == "Entrance - Motorcycle"|
         entranceFeeType == "Entrance - Per Person")
```

```{r}
fees |>
  group_by(entranceFeeType) |>
  summarise(averageCost= mean(cost))
```

```{r}
ggplot(data = fees, aes(x = entranceFeeType, y = cost)) +
  geom_boxplot(aes(fill = entranceFeeType)) +
  xlab(NULL) +
  theme(axis.text.x = element_blank()) +
  scale_fill_manual(values = c("turquoise4", "seagreen3", "turquoise2"), name = "Fee Type") +
  labs(title = "NPS Fees by Type of Entrance")
```


