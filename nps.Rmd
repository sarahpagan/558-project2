---
title: "NPS API Vignette"
subtitle: "Vignette for pulling data from the National Park Service API"
output: 
  github_document:
    toc: TRUE
    toc_depth: 1
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)

library(httr)
library(jsonlite)
library(dplyr)
library(ggplot2)
library(sf)

myKey <- "oKmYKW6S1dOrI47ra4laE70chvKFy5WGV1c0Pjgo"
```

# Overview

![parks](parks.png)

# Requirements

```{r}
get_NPS_activities <- function(key, activities){
  acts <- paste(activities, collapse = ",")
  url <- paste0("https://developer.nps.gov/api/v1/activities/parks?api_key=",
                key,
                "&q=",
                acts,
                "&limit=10000")
  
  query <- GET(url)
  results <- fromJSON(rawToChar(query$content))$data$parks
  
  activity <- c()
  for (i in 1:length(activities)){
    y <- rep(activities[i],
             nrow(results[[i]]))
    activity <- append(activity, y)
  }
  
  results <- results |>
    bind_rows() |>
    cbind(activity) |>
    select(fullName, activity, states)
  
  return(results)
}
```

```{r}
a <- GET(paste0("https://developer.nps.gov/api/v1/activities?api_key=", myKey))
fromJSON(rawToChar(a$content))$data$name
```

```{r}
get_NPS_activities(myKey, c("climbing", "swimming")) |>
  group_by(fullName) |>
  filter(n() > 1) |>
  select(-activity) |>
  distinct(fullName, states)
```

```{r}
get_NPS_parks <- function(key, states = NULL){
  if(is.null(states)){
    url <- paste0("https://developer.nps.gov/api/v1/parks?api_key=",
                  key,
                  "&limit=10000")
  }
  
  if(!is.null(states)){
    url <- paste0("https://developer.nps.gov/api/v1/parks?api_key=",
                  key,
                  "&stateCode=",
                  paste(states, collapse = ","),
                  "&limit=10000")
  }

query <- GET(url)
results <- fromJSON(rawToChar(query$content))$data

return(results)
}
```

```{r}
get_NPS_codes <- function(key) {
  url <- paste0("https://developer.nps.gov/api/v1/parks?api_key=",
                  key,
                  "&limit=10000")
  query <- GET(url)
  results <- fromJSON(rawToChar(query$content))$data
  results |>
    select(fullName, parkCode, states)
}

get_NPS_campgrounds <- function(key, park_code = NULL){
  parks <- get_NPS_codes(key)
  
  if(is.null(park_code)){
    url <- paste0("https://developer.nps.gov/api/v1/campgrounds?api_key=",
                  key,
                  "&limit=10000")
  }
  
  if(!is.null(park_code)){
    url <- paste0("https://developer.nps.gov/api/v1/campgrounds?api_key=",
                  key,
                  "&parkCode=",
                  park_code,
                  "&limit=10000")
  }
  
  query <- GET(url)
  camps <- fromJSON(rawToChar(query$content))$data |>
    select(name, parkCode) |>
    left_join(parks)
  results <- cbind(camps, fromJSON(rawToChar(GET(url)$content))$data$amenities)
  
  return(results)
}
```

```{r}
library(ggplot2)
library(sf)

NC <- get_NPS_parks(myKey, "NC")

NC <- NC |>
  mutate(long = as.numeric(longitude), .keep = "unused") |>
  mutate(lat = as.numeric(latitude), .keep = "unused") |>
  filter(parkCode != "trte", parkCode != "appa")

nc <- st_read(system.file("shape/nc.shp", package="sf"))
ggplot(nc) +
  geom_sf(color = "darkgreen", fill = "white", size = 10) +
  geom_point(data = NC, mapping = aes(x = long, y = lat)) +
  ggrepel::geom_text_repel(data = NC, aes(x = long, y = lat, label = parkCode)) +
  theme_void() +
  labs(title = "Parks in North Carolina") +
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab(NULL) + ylab(NULL)
```

